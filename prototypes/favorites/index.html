<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="prototype:description" content="Favorite cooking modes manager with rotary navigation, editable labels, icon swaps, reorder flow, and removal actions via bottom sheet.">
    <title>Cooking Methods Prototype</title>
    <script src="https://kit.fontawesome.com/8dfe425c81.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../../shared/prototype-shell.css">
    <link rel="stylesheet" href="../../shared/components/list-item.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .prototype-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            overflow: hidden;
        }

        .screen-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .screen-scroll {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: none;
        }

        .screen-scroll::-webkit-scrollbar {
            display: none;
        }

        .list-item {
            display: flex;
            align-items: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 10px 6px;
            min-height: 48px;
            font-size: 22px;
            font-weight: 500;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 28px;
            cursor: pointer;
            transition: all 0ms ease;
            position: relative;
            box-sizing: border-box;
        }

        .list-item.focused {
            background: #FFFFFF;
            color: black;
            border: 1px solid #333;
        }

        .list-item.disabled {
            background: transparent;
            color: #979797;
            cursor: not-allowed;
            border: none;
        }

        .list-item.reordered {
            background: #FFFFFF;
            color: black;
            border: 1px solid #333;
            position: relative;
        }

        .list-item.reordered::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 50%;
            transform: translateX(50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #ff6b6b;
        }

        .list-item.reordered::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 50%;
            transform: translateX(50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #ff6b6b;
        }

        .list-item.reordered.reorder-at-top::before {
            content: none;
        }

        .list-item.reordered.reorder-at-bottom::after {
            content: none;
        }

        .list-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leading-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: white;
        }


        .list-item.disabled .leading-icon {
            color: #979797;
        }


        .trailing-element {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: white;
            cursor: pointer;
        }

        .arrow-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: white;
        }

        .action-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .lock-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: white;
        }

        .list-item.disabled .close-icon,
        .list-item.disabled .arrow-icon,
        .list-item.disabled .action-icon,
        .list-item.disabled .lock-icon,
        .list-item.disabled .cooking-icon {
            color: #979797;
        }

        .cooking-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: white;
        }

        .list-item.focused .cooking-icon {
            color: black;
        }

        .rack-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .list-item.disabled .rack-icon {
            color: #979797;
        }

        .list-item.focused .rack-icon,
        .list-item.reordered .rack-icon {
            color: black;
        }

        .label-lv2-xs {
            font-size: var(--label-xs-lv2, 14px);
            line-height: var(--label-xs-lv2-line-height, 18px);
            font-family: var(--label-xs-lv2-font, 'Inter', sans-serif);
            font-weight: var(--label-xs-lv2-weight, 500);
            letter-spacing: var(--label-xs-lv2-spacing, 0.08em);
            font-feature-settings: var(--label-xs-lv2-features, 'ss01' 1, 'ss02' 1);
            text-transform: uppercase;
        }

        .label-lv1-sm {
            font-size: var(--label-sm-lv1, 16px);
            line-height: var(--label-sm-lv1-line-height, 20px);
            font-family: var(--label-sm-lv1-font, 'Inter', sans-serif);
            font-weight: var(--label-sm-lv1-weight, 400);
            letter-spacing: var(--label-sm-lv1-spacing, 0.01em);
            text-transform: none;
        }

        list-item.detail-metrics,
        .list-item.detail-metrics {
            padding: 10px 6px;
            border-radius: 8px;
            align-items: flex-start;
        }

        list-item.detail-metrics .list-item-content,
        .list-item.detail-metrics .list-item-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
            width: 100%;
        }

        list-item.detail-metrics .detail-label-container,
        .list-item.detail-metrics .detail-label-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        list-item.detail-metrics .detail-header-row,
        .list-item.detail-metrics .detail-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
        }

        list-item.detail-metrics .detail-header,
        .list-item.detail-metrics .detail-header {
            flex: 1;
            display: block;
            font-size: inherit;
            font-weight: inherit;
            line-height: inherit;
        }

        list-item.detail-metrics .trailing-element,
        .list-item.detail-metrics .trailing-element {
            align-self: center;
        }

        list-item.detail-metrics .detail-header-row .trailing-element,
        .list-item.detail-metrics .detail-header-row .trailing-element {
            margin-left: 16px;
        }

        list-item.detail-metrics .detail-card,
        .list-item.detail-metrics .detail-card {
            display: none;
            width: 100%;
            background: rgb(0 0 0 / 8%);
            border-radius: 8px;
            padding: 12px 14px;
            box-sizing: border-box;
            color: inherit;
            flex-direction: column;
            gap: 12px;
        }

        list-item.detail-metrics .detail-subheader,
        .list-item.detail-metrics .detail-subheader {
            display: none;
            color: #000;
        }

        list-item.detail-metrics .detail-metrics-row,
        .list-item.detail-metrics .detail-metrics-row {
            display: flex;
            justify-content: space-between;
            gap: 0;
        }

        list-item.detail-metrics .detail-metric,
        .list-item.detail-metrics .detail-metric {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            height: 56px;
        }

        list-item.detail-metrics .detail-value,
        .list-item.detail-metrics .detail-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-size: 32px;
            font-weight: 600;
        }

        list-item.detail-metrics .detail-value.detail-value-stacked,
        .list-item.detail-metrics .detail-value.detail-value-stacked {
            flex-direction: column;
            gap: 4px;
        }

        list-item.detail-metrics .detail-value.detail-value-stacked i,
        .list-item.detail-metrics .detail-value.detail-value-stacked i {
            font-size: 22px;
        }

        list-item.detail-metrics .detail-value .detail-unit,
        .list-item.detail-metrics .detail-value .detail-unit {
            font-size: 14px;
            font-weight: 500;
        }

        list-item.detail-metrics .detail-label,
        .list-item.detail-metrics .detail-label {
            color: rgb(0 0 0 / 65%);
            margin-top: auto;
            padding-top: 6px;
        }

        list-item.detail-metrics .detail-footnote,
        .list-item.detail-metrics .detail-footnote {
            display: none;
            width: 100%;
            color: #000;
        }

        list-item.detail-metrics.focused .detail-card,
        .list-item.detail-metrics.focused .detail-card {
            display: flex;
        }

        list-item.detail-metrics.focused .detail-footnote,
        .list-item.detail-metrics.focused .detail-footnote {
            display: block;
        }

        list-item.detail-metrics.focused .detail-subheader,
        .list-item.detail-metrics.focused .detail-subheader {
            display: block;
        }

        list-item.detail-metrics.reordered .detail-card,
        .list-item.detail-metrics.reordered .detail-card,
        list-item.detail-metrics.disabled .detail-card,
        .list-item.detail-metrics.disabled .detail-card,
        list-item.detail-metrics.reordered .detail-footnote,
        .list-item.detail-metrics.reordered .detail-footnote,
        list-item.detail-metrics.disabled .detail-footnote,
        .list-item.detail-metrics.disabled .detail-footnote {
            display: none;
        }

        .list-item.focused .leading-icon,
        .list-item.focused .arrow-icon,
        .list-item.focused .action-icon,
        .list-item.focused .close-icon,
        .list-item.focused .lock-icon {
            color: black;
        }

        .list-item.reordered .leading-icon,
        .list-item.reordered .arrow-icon,
        .list-item.reordered .action-icon,
        .list-item.reordered .close-icon,
        .list-item.reordered .lock-icon,
        .list-item.reordered .cooking-icon {
            color: black;
        }

        .list-item.reorder-confirmation {
            animation: reorderPulse 0.6s ease-in-out 3;
        }

        .bottom-sheet {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            transform: translateY(100%);
            height: 482px;
            border: double 2px transparent;
            border-radius: 12px 12px 0 0;
            background-image: linear-gradient(black, black),
                              linear-gradient(to top, #000000 0%, #5f5f5f 30%, #5f5f5f 100%);
            background-origin: border-box;
            background-clip: content-box, border-box;
            background-color: black;
            border-bottom: 0;
            transition: transform 0.25s ease-out;
            z-index: 1000;
        }

        .bottom-sheet.sliding-up {
            transition: transform 0.5s ease-out;
        }

        .bottom-sheet.visible {
            transform: translateY(0);
        }

        .bottom-sheet-content {
            padding: 32px 8px 16px 8px;
            height: 100%;
            box-sizing: border-box;
        }

        .bottom-sheet-title {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 32px;
            padding: 0 16px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .bottom-sheet-gap {
            height: 13px;
        }

        .bottom-sheet-divider {
            height: 2px;
            background: #3D3D3D;
            width: 100%;
            border-radius: 999px;
        }

        .toggle {
            width: 45px;
            height: 28px;
            background: #333;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle.active {
            background: #2BB671;
        }

        .toggle.disabled {
            background: #979797;
            cursor: not-allowed;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle.active::after {
            transform: translateX(21px);
        }

        .press-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 32px;
            background: #666;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .press-indicator.visible {
            opacity: 1;
        }

        .press-indicator.fade-out {
            opacity: 0;
        }

        .press-progress {
            width: 24px;
            height: 24px;
            transform: rotate(-90deg);
            overflow: visible;
        }

        .progress-circle {
            fill: none;
            stroke: white;
            stroke-width: 2;
            stroke-dasharray: 0 75.36;
            transition: none;
        }

        .press-text {
            color: white;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .bottom-sheet .option-text {
            color: inherit;
        }

        @keyframes reorderPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div class="outer-container">
        <div class="prototype-container">
            <div class="screen-container">
                <div class="screen-scroll" id="mainScreen">
                    <!-- List items populated dynamically -->
                </div>
            </div>


            <!-- Bottom Sheet -->
            <div class="bottom-sheet" id="bottomSheet">
                <div class="bottom-sheet-content">
                    <div class="bottom-sheet-title" id="bottomSheetTitle">Edit Bake</div>
                    
                    <list-item class="list-item" state="focused" data-action="rename">
                        <span slot="label">Rename</span>
                        <span slot="trailing" class="option-text" id="renameCurrentName">Bake</span>
                        <div slot="trailing" class="arrow-icon"><i class="fa-kit fa-chevron-right"></i></div>
                    </list-item>

                    <list-item class="list-item" data-action="change-icon">
                        <span slot="label">Change Icon</span>
                        <div slot="trailing" class="action-icon"><i class="fa-kit fa-pen-to-square"></i></div>
                        <div slot="trailing" class="arrow-icon"><i class="fa-kit fa-chevron-right"></i></div>
                    </list-item>

                    <list-item class="list-item" data-action="edit-on-app">
                        <span slot="label">Edit on App</span>
                        <div slot="trailing" class="action-icon"><i class="fa-kit fa-arrow-up-right-from-square"></i></div>
                        <div slot="trailing" class="arrow-icon"><i class="fa-kit fa-chevron-right"></i></div>
                    </list-item>

                    <list-item class="list-item" data-action="reorganize">
                        <span slot="label">Reorganize</span>
                        <div slot="trailing" class="arrow-icon"><i class="fa-kit fa-chevron-right"></i></div>
                    </list-item>

                    <list-item class="list-item" data-action="view-original">
                        <span slot="label">View Original</span>
                        <div slot="trailing" class="arrow-icon"><i class="fa-kit fa-chevron-right"></i></div>
                    </list-item>

                    <list-item class="list-item" data-action="remove-favorite">
                        <span slot="label">Remove Favorite</span>
                        <div slot="trailing" class="action-icon"><i class="fa-kit fa-circle-slash"></i></div>
                    </list-item>

                    <div class="bottom-sheet-gap"></div>
                    <div class="bottom-sheet-divider"></div>
                    <div class="bottom-sheet-gap"></div>

                    <list-item class="list-item" data-action="system-settings">
                        <span slot="label">System Settings</span>
                        <div slot="trailing" class="arrow-icon"><i class="fa-kit fa-chevron-right"></i></div>
                    </list-item>
                </div>
            </div>

            <!-- Press Indicator -->
            <div class="press-indicator" id="pressIndicator">
                <svg class="press-progress" id="pressProgress">
                    <circle class="progress-circle" cx="12" cy="12" r="12"></circle>
                </svg>
                <span class="press-text">Hold to edit mode</span>
            </div>
        </div>
    </div>
    <script type="module" src="../list-item/list-item-component.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mainScreen = document.getElementById('mainScreen');
            const bottomSheetItems = document.querySelectorAll('.bottom-sheet list-item');
            const reorganizeItemIndex = Array.from(bottomSheetItems).findIndex(item => item.dataset.action === 'reorganize');
            const bottomSheet = document.getElementById('bottomSheet');
            const bottomSheetTitle = document.getElementById('bottomSheetTitle');
            const renameCurrentName = document.getElementById('renameCurrentName');
            const pressIndicator = document.getElementById('pressIndicator');
            const pressProgress = document.getElementById('pressProgress');
            
            let currentMainIndex = 0;
            let currentBottomIndex = 0;
            let qPressStart = null;
            let qPressTimer = null;
            let qProgressTimer = null;
            let isBottomSheetOpen = false;
            let isReorderMode = false;
            let reorderingIndex = 0; // Index of item being moved
            let currentReorderModes = []; // Copy of modes array for reordering
            let isReorderFeedbackActive = false;

            const favoriteModes = [
                {
                    name: 'Bake',
                    icon: 'fa-kit fa-mode-bake',
                    detail: {
                        header: 'Bake',
                        metrics: [
                            { value: '325', unit: '째F', label: 'TEMP' },
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '15:00', label: 'MIN-SEC' },
                        ],
                    },
                },
                {
                    name: 'Toast',
                    icon: 'fa-kit fa-mode-toast',
                    detail: {
                        header: 'Toast',
                        metrics: [
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '25:00', label: 'MIN-SEC' },
                        ],
                        footnote: 'Darkness 4, Amount 4',
                    },
                },
                {
                    name: 'Bagel',
                    icon: 'fa-kit fa-mode-bagel',
                    detail: {
                        header: 'Bagel',
                        metrics: [
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '5:00', label: 'MIN-SEC' },
                        ],
                        footnote: 'Darkness 7, Amount 3',
                    },
                },
                {
                    name: 'Bacon',
                    icon: 'fa-kit fa-mode-roast',
                    detail: {
                        header: 'Bacon',
                        subheader: 'Roast',
                        metrics: [
                            { value: '320', unit: '째F', label: 'TEMP' },
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '14:00', label: 'MIN-SEC' },
                        ],
                        footnote: 'Doneness 7, Amount 3',
                    },
                },
                {
                    name: 'Custom Cook',
                    icon: 'fa-kit fa-mode-dial',
                    detail: {
                        header: 'Custom Cook',
                        subheader: 'Manual',
                        metrics: [
                            { value: '320', unit: '째F', label: 'TEMP' },
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '14:00', label: 'MIN-SEC' },
                        ],
                        footnote: 'Doneness 7, Amount 3',
                    },
                },
                {
                    name: 'Salmon',
                    icon: 'fa-kit fa-mode-slow-cook',
                    detail: {
                        header: 'Salmon',
                        subheader: 'Bake',
                        metrics: [
                            { value: '325', unit: '째F', label: 'TEMP' },
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '25:00', label: 'MIN-SEC' },
                        ],
                        footnote: 'Doneness 7, Amount 3',
                    },
                },
                {
                    name: 'NY Strip Steak',
                    icon: 'fa-kit fa-mode-broil',
                    detail: {
                        header: 'NY Strip Steak',
                        subheader: 'Broil',
                        metrics: [
                            { value: 'HIGH', label: 'LEVEL' },
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '7:00', label: 'MIN-SEC' },
                        ],
                        footnote: 'Doneness Rare, Depth 0.5in',
                    },
                },
                {
                    name: 'Chicken Wings',
                    icon: 'fa-kit fa-mode-air-fry',
                    detail: {
                        header: 'Chicken Wings',
                        subheader: 'Autopilot',
                        metrics: [
                            { value: 'AUTO', label: 'TEMP' },
                            { icon: 'fa-kit fa-rack-3-bottom', stacked: true, label: 'RACK' },
                            { value: '25:00', label: 'MIN-SEC' },
                        ],
                        footnote: 'Amount 3-8 Wings',
                    },
                },
            ];

            const buildDetailLabel = (detail, state = 'default') => {
                const container = document.createElement('div');
                container.className = 'detail-label-container';

                const headerRow = document.createElement('div');
                headerRow.className = 'detail-header-row';
                container.appendChild(headerRow);

                const header = document.createElement('span');
                header.className = 'detail-header';
                header.textContent = detail.header;
                headerRow.appendChild(header);

                const detailCard = document.createElement('div');
                detailCard.className = 'detail-card';

                if (detail.subheader) {
                    const subheader = document.createElement('div');
                    subheader.className = 'detail-subheader label-lv1-sm';
                    subheader.textContent = detail.subheader;
                    container.appendChild(subheader);
                }

                if (detail.metrics && detail.metrics.length > 0) {
                    const metricsRow = document.createElement('div');
                    metricsRow.className = 'detail-metrics-row';

                    detail.metrics.forEach((metric) => {
                        const metricEl = document.createElement('div');
                        metricEl.className = 'detail-metric';

                        const valueEl = document.createElement('div');
                        valueEl.className = 'detail-value';
                        if (metric.stacked) {
                            valueEl.classList.add('detail-value-stacked');
                        }

                        if (metric.value) {
                            const valueSpan = document.createElement('span');
                            valueSpan.textContent = metric.value;
                            valueEl.appendChild(valueSpan);
                        }

                        if (metric.icon) {
                            const icon = document.createElement('i');
                            icon.className = metric.icon;
                            valueEl.appendChild(icon);
                        }

                        if (metric.unit) {
                            const unitSpan = document.createElement('span');
                            unitSpan.className = 'detail-unit';
                            unitSpan.textContent = metric.unit;
                            valueEl.appendChild(unitSpan);
                        }

                        metricEl.appendChild(valueEl);

                        const labelEl = document.createElement('div');
                        labelEl.className = 'detail-label label-lv2-xs';
                        labelEl.textContent = metric.label;
                        metricEl.appendChild(labelEl);

                        metricsRow.appendChild(metricEl);
                    });

                    detailCard.appendChild(metricsRow);
                }

                container.appendChild(detailCard);

                if (detail.footnote) {
                    const footnote = document.createElement('div');
                    footnote.className = 'detail-footnote label-lv1-sm';
                    footnote.textContent = detail.footnote;
                    container.appendChild(footnote);
                }

                return container;
            };

            function updateMainFocus(newIndex) {
                const currentMainListItems = mainScreen.querySelectorAll('list-item');
                
                if (currentMainListItems[currentMainIndex]) {
                    currentMainListItems[currentMainIndex].state = 'default';
                }
                
                currentMainIndex = newIndex;
                
                if (currentMainListItems[currentMainIndex]) {
                    currentMainListItems[currentMainIndex].state = 'focused';
                    currentMainListItems[currentMainIndex].scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest'
                    });
                }

                updateBottomSheetTitle();
            }

            function updateBottomSheetFocus(newIndex) {
                // Remove focused class from current bottom sheet item
                bottomSheetItems[currentBottomIndex].state = 'default';
                
                // Update index
                currentBottomIndex = newIndex;
                
                // Add focused class to new bottom sheet item
                bottomSheetItems[currentBottomIndex].state = 'focused';
            }

            function updateBottomSheetTitle() {
                const selectedMode = favoriteModes[currentMainIndex]?.name || 'Favorite';
                bottomSheetTitle.textContent = `Edit ${selectedMode}`;
                if (renameCurrentName) {
                    renameCurrentName.textContent = selectedMode;
                }
            }

            function showPressIndicator() {
                // Remove any fade-out class and add visible for smooth fade-in
                pressIndicator.classList.remove('fade-out');
                pressIndicator.classList.add('visible');
                
                const circle = pressProgress.querySelector('.progress-circle');
                circle.style.strokeDasharray = '0 75.36'; // 12px radius circle circumference
                
                // Animate progress over 1.2 seconds (from 300ms to 1500ms total)
                const duration = 1200;
                const startTime = Date.now();
                
                qProgressTimer = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const circumference = 75.36;
                    const dashArray = (progress * circumference) + ' ' + circumference;
                    circle.style.strokeDasharray = dashArray;
                }, 16); // ~60fps
            }

            function hidePressIndicator() {
                pressIndicator.classList.add('fade-out');
                pressIndicator.classList.remove('visible');
                if (qProgressTimer) {
                    clearInterval(qProgressTimer);
                    qProgressTimer = null;
                }
                
                // Remove fade-out class after transition completes
                setTimeout(() => {
                    pressIndicator.classList.remove('fade-out');
                }, 300);
            }

            function showBottomSheet() {
                updateBottomSheetTitle();
                
                // Always reset to the Rename option (index 0) and clear any existing focus
                bottomSheetItems.forEach(item => item.state = 'default');
                currentBottomIndex = 0;
                bottomSheetItems[currentBottomIndex].state = 'focused';
                
                bottomSheet.classList.add('sliding-up');
                bottomSheet.classList.add('visible');
                isBottomSheetOpen = true;
            }

            function hideBottomSheet() {
                bottomSheet.classList.remove('sliding-up');
                bottomSheet.classList.remove('visible');
                isBottomSheetOpen = false;
            }

            function showReorderScreen() {
                // Set up reorder mode
                isReorderMode = true;
                reorderingIndex = currentMainIndex; // Start with the selected item
                currentReorderModes = [...favoriteModes]; // Make a copy of the array
                
                // Hide bottom sheet
                hideBottomSheet();
                
                // Update main screen for reorder mode
                updateMainScreenForReorder();
                
                // Update state
                isBottomSheetOpen = false;
            }

            function updateMainScreenForReorder() {               
                const listItems = mainScreen.querySelectorAll('list-item');
                listItems.forEach((item, index) => {
                    const isBeingReordered = index === reorderingIndex;
                    
                    item.classList.remove('reorder-confirmation');
                    item.state = isBeingReordered ? 'reordered' : 'disabled';
                    item.classList.toggle('reorder-at-top', isBeingReordered && reorderingIndex === 0);
                    item.classList.toggle('reorder-at-bottom', isBeingReordered && reorderingIndex === currentReorderModes.length - 1);
                });
                
                scrollReorderingItemIntoView('auto');
            }

            function moveItemUp() {
                if (reorderingIndex > 0) {
                    // Swap with previous item
                    const temp = currentReorderModes[reorderingIndex];
                    currentReorderModes[reorderingIndex] = currentReorderModes[reorderingIndex - 1];
                    currentReorderModes[reorderingIndex - 1] = temp;
                    
                    // Update reordering index
                    reorderingIndex--;
                    
                    // Refresh the main screen display
                    refreshMainScreenForReorder('smooth');
                }
            }

            function moveItemDown() {
                if (reorderingIndex < currentReorderModes.length - 1) {
                    // Swap with next item
                    const temp = currentReorderModes[reorderingIndex];
                    currentReorderModes[reorderingIndex] = currentReorderModes[reorderingIndex + 1];
                    currentReorderModes[reorderingIndex + 1] = temp;
                    
                    // Update reordering index
                    reorderingIndex++;
                    
                    // Refresh the main screen display
                    refreshMainScreenForReorder('smooth');
                }
            }

            function confirmReorder() {
                // Update the main favorites array order
                favoriteModes.length = 0;
                favoriteModes.push(...currentReorderModes);
                
                // Update current index to new position
                currentMainIndex = reorderingIndex;
                
                // Reset reorder mode
                isReorderMode = false;
                
                // Refresh main screen back to normal mode
                refreshMainScreen();
                animateReorderFeedback();
            }

            function createListItemElement(mode, state = 'default') {
                const listItem = document.createElement('list-item');
                listItem.classList.add('list-item');

                const detail = mode.detail ? { ...mode.detail, header: mode.detail.header || mode.name } : null;

                if (detail) {
                    listItem.classList.add('detail-metrics');
                    const labelContent = buildDetailLabel(detail, state);
                    labelContent.setAttribute('slot', 'label');
                    listItem.appendChild(labelContent);
                } else {
                    listItem.setAttribute('label', mode.name);
                }

                const trailingIcon = document.createElement('div');
                trailingIcon.slot = 'trailing';
                trailingIcon.className = detail ? 'cooking-icon rack-icon' : 'cooking-icon';
                const iconClass = mode.icon || 'fa-kit fa-rack-3-bottom';
                trailingIcon.innerHTML = `<i class="${iconClass}"></i>`;
                listItem.appendChild(trailingIcon);

                if (state && state !== 'default') {
                    listItem.state = state;
                }

                return listItem;
            }

            function refreshMainScreenForReorder(scrollBehavior = 'auto') {
                mainScreen.innerHTML = '';
                
                currentReorderModes.forEach((mode, index) => {
                    const state = index === reorderingIndex ? 'reordered' : 'disabled';
                    const listItem = createListItemElement(mode, state);
                    listItem.classList.toggle('reorder-at-top', state === 'reordered' && reorderingIndex === 0);
                    listItem.classList.toggle('reorder-at-bottom', state === 'reordered' && reorderingIndex === currentReorderModes.length - 1);
                    mainScreen.appendChild(listItem);
                });
                
                scrollReorderingItemIntoView(scrollBehavior);
            }
            
            function refreshMainScreen() {
                mainScreen.innerHTML = '';
                
                favoriteModes.forEach((mode, index) => {
                    const state = index === currentMainIndex ? 'focused' : 'default';
                    const listItem = createListItemElement(mode, state);
                    mainScreen.appendChild(listItem);
                });
            }

            function scrollReorderingItemIntoView(behavior = 'auto') {
                if (!isReorderMode) {
                    return;
                }
                
                const listItems = mainScreen.querySelectorAll('list-item');
                const targetItem = listItems[reorderingIndex];
                
                if (targetItem) {
                    const container = mainScreen;
                    const containerRect = container.getBoundingClientRect();
                    const targetRect = targetItem.getBoundingClientRect();
                    
                    const offsetTop = targetRect.top - containerRect.top;
                    const offsetBottom = targetRect.bottom - containerRect.bottom;
                    
                    if (offsetTop < 0) {
                        container.scrollTo({
                            top: container.scrollTop + offsetTop,
                            behavior
                        });
                    } else if (offsetBottom > 0) {
                        container.scrollTo({
                            top: container.scrollTop + offsetBottom,
                            behavior
                        });
                    }
                }
            }

            refreshMainScreen();
            updateBottomSheetTitle();

            function animateReorderFeedback() {
                const listItems = mainScreen.querySelectorAll('list-item');
                
                if (!listItems.length) {
                    return;
                }
                
                const targetItem = listItems[currentMainIndex];
                if (!targetItem) {
                    return;
                }
                
                isReorderFeedbackActive = true;
                
                const previousStates = new Map();
                
                listItems.forEach((item, index) => {
                    if (index !== currentMainIndex) {
                        previousStates.set(item, item.state || 'default');
                        item.state = 'disabled';
                    }
                });
                
                targetItem.classList.add('reorder-confirmation');
                
                targetItem.addEventListener('animationend', function handleAnimationEnd() {
                    targetItem.classList.remove('reorder-confirmation');
                    listItems.forEach((item, index) => {
                        if (index === currentMainIndex) {
                            item.state = 'focused';
                        } else {
                            const previousState = previousStates.get(item) || 'default';
                            item.state = previousState;
                        }
                    });
                    isReorderFeedbackActive = false;
                }, { once: true });
            }

            document.addEventListener('keydown', function(event) {
                if (isReorderFeedbackActive) {
                    event.preventDefault();
                    return;
                }
                
                if (event.key.toLowerCase() === 'q') {
                    event.preventDefault();
                    
                    if (isReorderMode) {
                        // Confirm reorder and return to main screen
                        confirmReorder();
                    } else if (isBottomSheetOpen) {
                        // Check if we're on the Reorganize item
                        if (reorganizeItemIndex !== -1 && currentBottomIndex === reorganizeItemIndex) {
                            showReorderScreen();
                        }
                    } else if (qPressStart === null) {
                        qPressStart = Date.now();
                        
                        // Show toast after 300ms
                        qPressTimer = setTimeout(() => {
                            showPressIndicator();
                            
                            // Start bottom sheet animation after 1 second (700ms more)
                            qPressTimer = setTimeout(() => {
                                showBottomSheet();
                                
                                // Hide toast when sheet reaches the top (after 0.5s animation)
                                setTimeout(() => {
                                    hidePressIndicator();
                                }, 500); // Bottom sheet animation duration
                            }, 700); // 1000ms total - 300ms already elapsed
                        }, 300);
                    }
                } else if (event.key.toLowerCase() === 'p') {
                    event.preventDefault();
                    if (isReorderMode) {
                        // Move item down in reorder mode
                        moveItemDown();
                    } else if (isBottomSheetOpen) {
                        // Navigate bottom sheet items
                        if (currentBottomIndex < bottomSheetItems.length - 1) {
                            updateBottomSheetFocus(currentBottomIndex + 1);
                        }
                    } else {
                        // Navigate main list items
                        const currentMainListItems = mainScreen.querySelectorAll('list-item');
                        if (currentMainIndex < currentMainListItems.length - 1) {
                            updateMainFocus(currentMainIndex + 1);
                        }
                    }
                } else if (event.key.toLowerCase() === 'o') {
                    event.preventDefault();
                    if (isReorderMode) {
                        // Move item up in reorder mode
                        moveItemUp();
                    } else if (isBottomSheetOpen) {
                        // Navigate bottom sheet items
                        if (currentBottomIndex > 0) {
                            updateBottomSheetFocus(currentBottomIndex - 1);
                        }
                    } else {
                        // Navigate main list items
                        const currentMainListItems = mainScreen.querySelectorAll('list-item');
                        if (currentMainIndex > 0) {
                            updateMainFocus(currentMainIndex - 1);
                        }
                    }
                }
            });

            document.addEventListener('keyup', function(event) {
                if (isReorderFeedbackActive) {
                    event.preventDefault();
                    return;
                }
                
                if (event.key.toLowerCase() === 'q' && qPressStart !== null) {
                    event.preventDefault();
                    const pressDuration = Date.now() - qPressStart;
                    
                    // Clear timers
                    if (qPressTimer) {
                        clearTimeout(qPressTimer);
                        qPressTimer = null;
                    }
                    
                    hidePressIndicator();
                    
                    // If released before 1.5 seconds, slide back down
                    if (pressDuration < 1500) {
                        hideBottomSheet();
                    } else {
                        // If after 1.5 seconds, finish pulling up
                        showBottomSheet();
                    }
                    
                    qPressStart = null;
                }
            });

        });
    </script>
</body>
</html>
